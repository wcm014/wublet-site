<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wublet Links</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    max-width: 700px;
    margin: 40px auto;
    padding: 0 20px;
  }
  h1 { margin-bottom: 0.5em; }
  .item {
    padding: 12px 0;
    border-bottom: 1px solid #ddd;
  }
  .date {
    color: #666;
    font-size: 0.9em;
  }
</style>
</head>
<body>

<h1>Wublet Links</h1>
<div id="items">Loadingâ€¦</div>

<script>
// GitHub repo info
const OWNER = 'wcm014';
const REPO  = 'wublet-site';
const PATH  = 'links';

async function listMarkdownFiles() {
  const apiUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;
  const res = await fetch(apiUrl);
  if (!res.ok) throw new Error('Failed to list files from GitHub API');
  const data = await res.json();

  // Keep only .md files
  return data
    .filter(item => item.type === 'file' && item.name.endsWith('.md'))
    .map(item => ({
      name: item.name,
      url: item.download_url
    }));
}

async function loadMarkdownFile(file) {
  const res = await fetch(file.url);
  if (!res.ok) throw new Error(`Failed to fetch ${file.name}`);
  const text = await res.text();

  const titleMatch = text.match(/title:\s*(.*)/);
  const dateMatch  = text.match(/date:\s*(.*)/);

  const title = titleMatch ? titleMatch[1].trim() : file.name;
  const dateStr = dateMatch ? dateMatch[1].trim() : '1970-01-01';
  const date = new Date(dateStr);

  const lines = text.trim().split('\n').filter(l => l.trim().length > 0);
  const url = lines[lines.length - 1].trim();

  return { title, date, url };
}

function render(items) {
  const container = document.getElementById('items');
  container.innerHTML = '';

  if (!items.length) {
    container.textContent = 'No links found yet.';
    return;
  }

  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <a href="${item.url}" target="_blank">${item.title}</a><br>
      <span class="date">${item.date.toLocaleString()}</span>
    `;
    container.appendChild(div);
  });
}

(async function () {
  const container = document.getElementById('items');
  try {
    const files = await listMarkdownFiles();
    const items = await Promise.all(files.map(loadMarkdownFile));
    items.sort((a, b) => b.date - a.date);
    render(items);
  } catch (err) {
    console.error(err);
    container.textContent = 'Error loading links.';
  }
})();
</script>

</body>
</html>
