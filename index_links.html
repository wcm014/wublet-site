<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wublet Links</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    max-width: 700px;
    margin: 40px auto;
    padding: 0 20px;
  }
  h1 { margin-bottom: 0.5em; }
  .item {
    padding: 12px 0;
    border-bottom: 1px solid #ddd;
  }
  .date {
    color: #666;
    font-size: 0.9em;
  }
</style>
</head>
<body>

<h1>Wublet Links</h1>
<div id="items">Loadingâ€¦</div>

<script>
// ---------- CONFIG ----------
const OWNER = 'wcm014';
const REPO  = 'wublet-site';
const PATH  = 'links';

// ---------- HELPERS ----------
function parseZapierDate(str) {
  // Example: "12/23/25 09:44AM"
  const match = str.match(/(\d{1,2})\/(\d{1,2})\/(\d{2}) (\d{1,2}):(\d{2})(AM|PM)/);
  if (!match) return new Date(0);

  let [_, month, day, year, hour, minute, ampm] = match;

  month = parseInt(month, 10) - 1;
  day = parseInt(day, 10);
  year = 2000 + parseInt(year, 10);
  hour = parseInt(hour, 10);
  minute = parseInt(minute, 10);

  if (ampm === 'PM' && hour !== 12) hour += 12;
  if (ampm === 'AM' && hour === 12) hour = 0;

  return new Date(year, month, day, hour, minute);
}

// Find the first plausible URL in the entire text
function extractFirstUrl(text) {
  // Look for http/https followed by anything up to whitespace
  const match = text.match(/https?:\/\/[^\s]+/);
  if (!match) return '';

  let url = match[0];

  // Strip trailing characters that commonly ride along from email/markdown
  url = url.replace(/[)"'\u201d\u201c]+$/g, '');

  return url;
}

// ---------- GITHUB API ----------
async function listMarkdownFiles() {
  const apiUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;
  const res = await fetch(apiUrl);
  if (!res.ok) throw new Error('Failed to list files from GitHub API');
  const data = await res.json();

  return data
    .filter(item => item.type === 'file' && item.name.endsWith('.md'))
    .map(item => ({
      name: item.name,
      url: item.download_url
    }));
}

// ---------- FILE PARSING ----------
async function loadMarkdownFile(file) {
  const res = await fetch(file.url);
  if (!res.ok) throw new Error(`Failed to fetch ${file.name}`);
  const text = await res.text();

  const titleMatch = text.match(/title:\s*(.*)/);
  const dateMatch  = text.match(/date:\s*(.*)/);

  const title = titleMatch ? titleMatch[1].trim() : file.name;
  const dateStr = dateMatch ? dateMatch[1].trim() : '01/01/70 00:00AM';
  const date = parseZapierDate(dateStr);

  const url = extractFirstUrl(text);

  return { title, date, url };
}

// ---------- RENDERING ----------
function render(items) {
  const container = document.getElementById('items');
  container.innerHTML = '';

  if (!items.length) {
    container.textContent = 'No links found yet.';
    return;
  }

  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';

    const safeUrl = item.url || '#';

    div.innerHTML = `
      <a href="${safeUrl}" target="_blank" rel="noopener noreferrer">
        ${item.title}
      </a><br>
      <span class="date">${item.date.toLocaleString()}</span>
      ${!item.url ? ' <span style="color:#b00;font-size:0.85em;">(no URL found)</span>' : ''}
    `;

    container.appendChild(div);
  });
}

// ---------- MAIN ----------
(async function () {
  const container = document.getElementById('items');
  try {
    const files = await listMarkdownFiles();
    const items = await Promise.all(files.map(loadMarkdownFile));
    items.sort((a, b) => b.date - a.date);
    render(items);
  } catch (err) {
    console.error(err);
    container.textContent = 'Error loading links.';
  }
})();
</script>

</body>
</html>
